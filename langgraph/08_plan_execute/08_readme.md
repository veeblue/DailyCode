# LangChain è®¡åˆ’æ‰§è¡Œæ™ºèƒ½ä½“

ä¸€ä¸ªåŸºäº LangChain å’Œ LangGraph æ„å»ºçš„æ™ºèƒ½è§„åˆ’æ‰§è¡Œç³»ç»Ÿï¼Œèƒ½å¤Ÿè‡ªåŠ¨åˆ†è§£å¤æ‚ä»»åŠ¡ã€åˆ¶å®šæ‰§è¡Œè®¡åˆ’ï¼Œå¹¶æ ¹æ®ç»“æœåŠ¨æ€è°ƒæ•´ç­–ç•¥ã€‚

## ğŸš€ åŠŸèƒ½ç‰¹æ€§

- **æ™ºèƒ½ä»»åŠ¡è§„åˆ’**: è‡ªåŠ¨å°†å¤æ‚æŸ¥è¯¢åˆ†è§£ä¸ºå¯æ‰§è¡Œæ­¥éª¤
- **åŠ¨æ€é‡æ–°è§„åˆ’**: æ ¹æ®ä¸­é—´ç»“æœè°ƒæ•´æ‰§è¡Œç­–ç•¥
- **ç½‘ç»œæœç´¢é›†æˆ**: ä½¿ç”¨ Tavily æœç´¢è·å–å®æ—¶ä¿¡æ¯
- **é”™è¯¯å¤„ç†**: å¼ºå¤§çš„é”™è¯¯æ¢å¤å’Œé™çº§æœºåˆ¶
- **å¼‚æ­¥å¤„ç†**: ä½¿ç”¨ async/await å®ç°é«˜æ•ˆå¹¶å‘æ“ä½œ
- **å¯è§†åŒ–å·¥ä½œæµ**: ç”Ÿæˆ Mermaid å›¾è¡¨å±•ç¤ºå·¥ä½œæµç¨‹

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

- **LangChain**: æ„å»º AI åº”ç”¨çš„æ ¸å¿ƒæ¡†æ¶
- **LangGraph**: çŠ¶æ€å›¾å·¥ä½œæµå¼•æ“
- **DeepSeek API**: ç”¨äºæ¨ç†å’Œè§„åˆ’çš„å¤§è¯­è¨€æ¨¡å‹
- **Tavily Search**: ä¿¡æ¯æ£€ç´¢çš„ç½‘ç»œæœç´¢å·¥å…·
- **Python 3.8+**: éœ€è¦ async/await æ”¯æŒ

## ğŸ“‹ å‰ç½®æ¡ä»¶

è¿è¡Œæ­¤åº”ç”¨å‰ï¼Œè¯·ç¡®ä¿æ‚¨æœ‰ï¼š

- Python 3.8 æˆ–æ›´é«˜ç‰ˆæœ¬
- DeepSeek API å¯†é’¥
- Tavily API å¯†é’¥ï¼ˆç”¨äºæœç´¢åŠŸèƒ½ï¼‰

## ğŸ”§ å®‰è£…

```bash
# å…‹éš†ä»“åº“
git clone <repository-url>
cd plan-execute-agent

# å®‰è£…ä¾èµ–
pip install langchain-community langchain-openai langgraph langchain-core
```

## âš™ï¸ é…ç½®

è®¾ç½®ç¯å¢ƒå˜é‡ï¼š

```bash
export DEEPSEEK_API_KEY="your-deepseek-api-key"
export TAVILY_API_KEY="your-tavily-api-key"
export LANGCHAIN_TRACING_V2="false"  # ç¦ç”¨ LangSmith è¿½è¸ª
```

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```mermaid
graph TD
    A[å¼€å§‹] --> B[è®¡åˆ’ç”Ÿæˆå™¨]
    B --> C[æ‰§è¡Œå™¨]
    C --> D[é‡æ–°è§„åˆ’å™¨]
    D --> E{æ˜¯å¦ç»“æŸ?}
    E -->|å¦| C
    E -->|æ˜¯| F[ç»“æŸ]
```

### æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | åŠŸèƒ½ | è¾“å…¥ | è¾“å‡º |
|------|------|------|------|
| **è®¡åˆ’ç”Ÿæˆå™¨** | å°†å¤æ‚ä»»åŠ¡åˆ†è§£ä¸ºæ­¥éª¤ | ç”¨æˆ·æŸ¥è¯¢ | æ­¥éª¤åˆ—è¡¨ |
| **æ‰§è¡Œå™¨** | æ‰§è¡Œå•ä¸ªè®¡åˆ’æ­¥éª¤ | å½“å‰æ­¥éª¤ | æ‰§è¡Œç»“æœ |
| **é‡æ–°è§„åˆ’å™¨** | è¯„ä¼°è¿›åº¦å¹¶å†³å®šä¸‹ä¸€æ­¥ | å†å²æ­¥éª¤ | æ–°è®¡åˆ’æˆ–æœ€ç»ˆç­”æ¡ˆ |
| **æœç´¢å·¥å…·** | è·å–å®æ—¶ä¿¡æ¯ | æœç´¢æŸ¥è¯¢ | æœç´¢ç»“æœ |

## ğŸ“Š æ•°æ®ç»“æ„

```python
class PlanExecute(TypedDict):
    input: str                    # ç”¨æˆ·è¾“å…¥çš„ä»»åŠ¡
    plan: List[str]              # è®¡åˆ’æ­¥éª¤åˆ—è¡¨
    past_steps: List[Tuple]      # å·²å®Œæˆæ­¥éª¤çš„å†å²è®°å½•
    response: str                # æœ€ç»ˆå“åº”
```

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½

### 1. æœç´¢æ‰§è¡Œ

```python
async def execute_search(query: str) -> str:
    """æ‰§è¡Œæœç´¢æŸ¥è¯¢å¹¶è¿”å›ç»“æœ"""
    try:
        results = search_tool.run(query)
        return str(results)
    except Exception as e:
        return f"æœç´¢å¤±è´¥: {str(e)}"
```

### 2. LLM ä»»åŠ¡æ‰§è¡Œ

```python
async def execute_with_llm(task: str) -> str:
    """ä½¿ç”¨ LLM æ‰§è¡Œä»»åŠ¡ï¼Œç»“åˆæœç´¢ç»“æœ"""
    # 1. æ‰§è¡Œæœç´¢è·å–ä¿¡æ¯
    search_results = await execute_search(f"æœç´¢å…³äº: {task}")
    
    # 2. ä½¿ç”¨ LLM åˆ†æç»“æœ
    response = await llm.ainvoke(analysis_prompt)
    return response.content
```

### 3. è®¡åˆ’ç”Ÿæˆ

```python
planner_prompt = ChatPromptTemplate.from_messages([
    ("system", "ä½ æ˜¯ä¸€ä¸ªè®¡åˆ’åŠ©æ‰‹ã€‚ä¸ºç»™å®šçš„ç›®æ ‡åˆ›å»ºä¸€ä¸ªç®€å•çš„é€æ­¥è®¡åˆ’..."),
    ("user", "{input}")
])

planner = planner_prompt | llm | plan_parser
```

### 4. é‡æ–°è§„åˆ’

```python
replanner_prompt = ChatPromptTemplate.from_template("""
åŸºäºåŸå§‹ç›®æ ‡ã€åŸå§‹è®¡åˆ’å’Œå·²å®Œæˆçš„æ­¥éª¤ï¼Œå†³å®šä¸‹ä¸€æ­¥è¦åšä»€ä¹ˆã€‚

è¿”å› JSON æ ¼å¼ï¼š
- action_type: "response" | "plan"
- content: æœ€ç»ˆç­”æ¡ˆæˆ–å‰©ä½™æ­¥éª¤
""")
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ä½¿ç”¨

```python
import asyncio

async def main():
    # åˆ›å»ºå·¥ä½œæµ
    workflow = StateGraph(PlanExecute)
    
    # æ·»åŠ èŠ‚ç‚¹
    workflow.add_node("planner", plan_step)
    workflow.add_node("agent", execute_step)
    workflow.add_node("replan", replan_step)
    
    # è®¾ç½®è¾¹
    workflow.add_edge(START, "planner")
    workflow.add_edge("planner", "agent")
    workflow.add_edge("agent", "replan")
    workflow.add_conditional_edges("replan", should_end)
    
    # ç¼–è¯‘å¹¶è¿è¡Œ
    app = workflow.compile()
    
    inputs = {
        "input": "2024å¹´å·´é»å¥¥è¿ä¼š100ç±³è‡ªç”±æ³³å†³èµ›å† å†›çš„å®¶ä¹¡æ˜¯å“ªé‡Œ?",
        "past_steps": []
    }
    
    async for event in app.astream(inputs, config={"recursion_limit": 50}):
        for k, v in event.items():
            if k != "__end__":
                print(f"èŠ‚ç‚¹ {k}: {v}")

# è¿è¡Œ
asyncio.run(main())
```

### è¾“å‡ºç¤ºä¾‹

```
èŠ‚ç‚¹ planner: {'plan': ['æœç´¢2024å¹´å·´é»å¥¥è¿ä¼š100ç±³è‡ªç”±æ³³å†³èµ›å† å†›', 'æŸ¥æ‰¾å† å†›çš„ä¸ªäººä¿¡æ¯', 'ç¡®å®šå† å†›çš„å®¶ä¹¡']}
èŠ‚ç‚¹ agent: {'past_steps': [('æœç´¢2024å¹´å·´é»å¥¥è¿ä¼š100ç±³è‡ªç”±æ³³å†³èµ›å† å†›', 'æ‰¾åˆ°å† å†›æ˜¯æ½˜å±•ä¹')]}
èŠ‚ç‚¹ replan: {'plan': ['æŸ¥æ‰¾æ½˜å±•ä¹çš„ä¸ªäººä¿¡æ¯å’Œå®¶ä¹¡']}
èŠ‚ç‚¹ agent: {'past_steps': [('æŸ¥æ‰¾æ½˜å±•ä¹çš„ä¸ªäººä¿¡æ¯å’Œå®¶ä¹¡', 'æ½˜å±•ä¹æ¥è‡ªæµ™æ±Ÿæ¸©å·')]}
èŠ‚ç‚¹ replan: {'response': '2024å¹´å·´é»å¥¥è¿ä¼š100ç±³è‡ªç”±æ³³å†³èµ›å† å†›æ½˜å±•ä¹çš„å®¶ä¹¡æ˜¯æµ™æ±Ÿæ¸©å·ã€‚'}
```

## ğŸ¯ é€‚ç”¨åœºæ™¯

- âœ… éœ€è¦å¤šæ­¥æ¨ç†çš„å¤æ‚é—®é¢˜
- âœ… éœ€è¦å®æ—¶ä¿¡æ¯æ£€ç´¢çš„ä»»åŠ¡
- âœ… éœ€è¦åŠ¨æ€è°ƒæ•´æ‰§è¡Œç­–ç•¥çš„åœºæ™¯
- âœ… çŸ¥è¯†å¯†é›†å‹é—®ç­”ç³»ç»Ÿ
- âœ… ç ”ç©¶å’Œåˆ†æä»»åŠ¡

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### å»ºè®®çš„ä¼˜åŒ–æ–¹å‘

- **ç¼“å­˜æœºåˆ¶**: å®ç°æœç´¢ç»“æœç¼“å­˜
- **å¹¶è¡Œæ‰§è¡Œ**: æ”¯æŒå¹¶è¡Œä»»åŠ¡æ‰§è¡Œ
- **æ™ºèƒ½è·¯ç”±**: æ ¹æ®ä»»åŠ¡ç±»å‹é€‰æ‹©æœ€ä¼˜æ‰§è¡Œè·¯å¾„
- **ç»“æœéªŒè¯**: æ·»åŠ ç»“æœéªŒè¯å’Œè´¨é‡è¯„ä¼°

### ç›‘æ§æŒ‡æ ‡

```python
# æ€§èƒ½æŒ‡æ ‡
- ä»»åŠ¡å®Œæˆæ—¶é—´
- LLM è°ƒç”¨æ¬¡æ•°
- æœç´¢æŸ¥è¯¢æ¬¡æ•°
- æˆåŠŸç‡
- é”™è¯¯ç‡
```

## ğŸ”’ å®‰å…¨è€ƒè™‘

- **API å¯†é’¥ç®¡ç†**: ä½¿ç”¨ç¯å¢ƒå˜é‡å­˜å‚¨æ•æ„Ÿä¿¡æ¯
- **è¾“å…¥éªŒè¯**: å¯¹ç”¨æˆ·è¾“å…¥è¿›è¡Œæ¸…ç†å’ŒéªŒè¯
- **é”™è¯¯å¤„ç†**: é¿å…æ•æ„Ÿä¿¡æ¯æ³„éœ²
- **é€Ÿç‡é™åˆ¶**: å®ç° API è°ƒç”¨é¢‘ç‡æ§åˆ¶

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| API å¯†é’¥é”™è¯¯ | ç¯å¢ƒå˜é‡æœªè®¾ç½® | æ£€æŸ¥ `DEEPSEEK_API_KEY` è®¾ç½® |
| æœç´¢å¤±è´¥ | ç½‘ç»œè¿æ¥é—®é¢˜ | æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œ Tavily API |
| JSON è§£æé”™è¯¯ | LLM è¾“å‡ºæ ¼å¼ä¸æ­£ç¡® | æ£€æŸ¥æç¤ºæ¨¡æ¿å’Œè¾“å‡ºè§£æå™¨ |
| é€’å½’é™åˆ¶ | ä»»åŠ¡è¿‡äºå¤æ‚ | å¢åŠ  `recursion_limit` æˆ–ç®€åŒ–ä»»åŠ¡ |

### è°ƒè¯•æŠ€å·§

```python
# å¯ç”¨è¯¦ç»†æ—¥å¿—
import logging
logging.basicConfig(level=logging.DEBUG)

# æ·»åŠ è°ƒè¯•è¾“å‡º
print(f"å½“å‰çŠ¶æ€: {state}")
print(f"æ‰§è¡Œç»“æœ: {result}")
```

## ğŸ“ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚

## ğŸ™ è‡´è°¢

- [LangChain](https://github.com/langchain-ai/langchain) - æ ¸å¿ƒæ¡†æ¶
- [LangGraph](https://github.com/langchain-ai/langgraph) - å·¥ä½œæµå¼•æ“
- [DeepSeek](https://www.deepseek.com/) - å¤§è¯­è¨€æ¨¡å‹
- [Tavily](https://tavily.com/) - æœç´¢ API


